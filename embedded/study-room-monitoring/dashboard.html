<!-- Dashboard fetched information from ESP32 Study Room Monitoring System data feeds on Adafruit IO and displays them -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Room Monitoring Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 30px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #ecf0f1;
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .dashboard-content {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 20px;
            padding: 30px;
        }

        @media (max-width: 768px) {
            .dashboard-content {
                grid-template-columns: 1fr;
            }
        }

        .room-display {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .room-status-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            transition: all 0.5s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 8px solid white;
        }

        .room-status {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .room-name {
            font-size: 2.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .sensors-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .sensor-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #3498db;
        }

        .sensor-card h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sensor-card h3 i {
            font-size: 1.2rem;
        }

        .sensor-value {
            font-size: 3.5rem;
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            margin: 10px 0;
        }

        .sensor-label {
            color: #7f8c8d;
            font-size: 1.1rem;
            text-align: center;
            margin-top: 5px;
        }

        .sensor-unit {
            font-size: 1.5rem;
            color: #7f8c8d;
        }

        .connection-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .connection-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: #e74c3c;
        }

        .connection-dot.connected {
            background-color: #2ecc71;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        .update-time {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-align: center;
            margin-top: 10px;
        }

        .room-message {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .room-message-text {
            font-size: 1.3rem;
            color: #2c3e50;
            font-style: italic;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }

        .noise-level {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .noise-bar {
            width: 80%;
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .noise-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ecc71, #f39c12, #e74c3c);
            width: 0%;
            transition: width 0.5s ease;
        }

        .noise-value {
            font-size: 1.2rem;
            font-weight: bold;
            min-width: 60px;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .control-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            background: #3498db;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .control-btn.occupied {
            background: #e74c3c;
        }

        .control-btn.available {
            background: #2ecc71;
        }

        .control-btn.maintenance {
            background: #f39c12;
        }

        .control-btn.quiet {
            background: #3498db;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-home"></i> Smart Room Monitor</h1>
            <p class="subtitle">Concordia University - Hall Building, 9th Floor</p>
        </header>

        <div class="dashboard-content">
            <div class="room-display">
                <h2 class="room-name" id="roomName">H968</h2>
                <div class="room-status-circle" id="roomStatusCircle">
                    <div class="room-status" id="roomStatus">Loading...</div>
                </div>

                <div class="room-message">
                    <div class="room-message-text" id="roomMessage">Waiting for room status update...</div>
                </div>
                <div class="update-time" id="lastUpdate">
                    Last updated: Never
                </div>
            </div>

            <div class="sensors-panel">
                <div class="sensor-card">
                    <h3><i class="fas fa-thermometer-half"></i> Temperature</h3>
                    <div class="sensor-value" id="temperatureValue">
                        <span id="temperature">--</span><span class="sensor-unit">Â°C</span>
                    </div>
                    <div class="sensor-label">Current Temperature</div>
                </div>

                <div class="sensor-card">
                    <h3><i class="fas fa-tint"></i> Humidity</h3>
                    <div class="sensor-value" id="humidityValue">
                        <span id="humidity">--</span><span class="sensor-unit">%</span>
                    </div>
                    <div class="sensor-label">Relative Humidity</div>
                </div>

                <div class="sensor-card">
                    <h3><i class="fas fa-volume-up"></i> Noise Level</h3>
                    <div class="noise-level">
                        <div class="noise-value" id="noiseValue">--</div>
                        <div class="noise-bar">
                            <div class="noise-fill" id="noiseFill"></div>
                        </div>
                    </div>
                    <div class="sensor-label">Ambient Noise Level</div>
                </div>
                <div class="sensor-card">
                    <h3><i class="fas fa-users"></i> Occupancy</h3>
                    <div class="sensor-value" id="peopleCountValue">
                        <span id="peopleCount">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="connection-status" id="connectionStatus">
        <div class="connection-dot" id="connectionDot"></div>
        <span id="connectionText">Connecting to Adafruit IO...</span>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <script>
        const AIO_USERNAME = "XXXXXX";      // replace with Adafruit IO username
        const AIO_KEY = "aio_XXXXXXXXXXXXXXXXXXXXXX";   // replace with Adafruit IO key
        const ROOM_NAME = "H968";

        // MQTT Configuration
        const clientId = "dashboard_" + Math.random().toString(16).substr(2, 8);
        const mqttUrl = `wss://io.adafruit.com:443/`;

        let mqttClient = null;
        let lastMessageTime = null;
        let isConnected = false;

        // Current room status and sensor values
        let currentRoomStatus = "unknown";
        let currentTemperature = null;
        let currentHumidity = null;
        let currentNoise = null;

        // Initialize dashboard
        function initDashboard() {
            updateConnectionStatus("Connecting to Adafruit IO...", false);
            connectMqtt();

            // Set room name
            document.getElementById('roomName').textContent = ROOM_NAME;

            // Start connection monitoring
            setInterval(checkConnection, 5000);

            // Start periodic status update
            setInterval(updateLastUpdateTime, 1000);
        }

        // Connect to Adafruit IO via MQTT WebSocket
        function connectMqtt() {
            try {
                // MQTT connection options
                const options = {
                    clientId: clientId,
                    username: AIO_USERNAME,
                    password: AIO_KEY,
                    clean: true,
                    reconnectPeriod: 5000, // Reconnect every 5 seconds if disconnected
                    connectTimeout: 10000, // 10 second connection timeout
                };

                console.log("Connecting to Adafruit IO MQTT...");

                // Connect to MQTT broker
                mqttClient = mqtt.connect(mqttUrl, options);

                // Set up event handlers
                mqttClient.on('connect', onConnect);
                mqttClient.on('message', onMessage);
                mqttClient.on('error', onError);
                mqttClient.on('close', onClose);
                mqttClient.on('offline', onOffline);
                mqttClient.on('reconnect', onReconnect);

            } catch (error) {
                console.error("Error creating MQTT client:", error);
                updateConnectionStatus("Connection error: " + error.message, false);
                setTimeout(connectMqtt, 5000); // Retry after 5 seconds
            }
        }

        // Connection established
        function onConnect() {
            console.log("Connected to Adafruit IO via MQTT WebSocket");
            updateConnectionStatus("Connected to Adafruit IO", true);
            isConnected = true;

            const feeds = [
                "room-status",
                "temperature",
                "humidity",
                "noise",
                "people-count",
            ];

            feeds.forEach(feed => {
                const topic = `${AIO_USERNAME}/feeds/${feed}`;
                mqttClient.subscribe(topic, { qos: 0 }, (err) => {
                    if (err) {
                        console.error(`Failed to subscribe to ${topic}:`, err);
                    } else {
                        console.log(`Subscribed to: ${topic}`);
                    }
                });
            });

            console.log("Waiting for sensor data...");
        }

        // Message received
        function onMessage(topic, message) {
            const payload = message.toString();
            const timestamp = new Date();

            lastMessageTime = timestamp;

            console.log("Received:", topic, payload);

            // Extract feed name from topic
            const feedName = topic.split('/').pop();

            // Update the appropriate value
            switch (feedName) {
                case 'room-status':
                    updateRoomStatus(payload);
                    break;
                case 'temperature':
                    updateTemperature(payload);
                    break;
                case 'humidity':
                    updateHumidity(payload);
                    break;
                case 'noise':
                    updateNoise(payload);
                    break;
                case 'people-count':
                    updatePeopleCount(payload);
                    break;
                default:
                    console.log("Unknown feed:", feedName);
            }

            updateLastUpdateTime();
        }

        // Error handler
        function onError(error) {
            console.error("MQTT Error:", error);
            updateConnectionStatus("Error: " + error.message, false);
            isConnected = false;
        }

        // Connection closed
        function onClose() {
            console.log("MQTT connection closed");
            updateConnectionStatus("Connection closed", false);
            isConnected = false;
        }

        // Client went offline
        function onOffline() {
            console.log("MQTT client offline");
            updateConnectionStatus("Offline", false);
            isConnected = false;
        }

        // Reconnection attempt
        function onReconnect() {
            console.log("Attempting to reconnect...");
            updateConnectionStatus("Reconnecting...", false);
        }

        // Update room status display
        function updateRoomStatus(status) {
            currentRoomStatus = status.toLowerCase();

            const roomStatusElement = document.getElementById('roomStatus');
            const roomStatusCircle = document.getElementById('roomStatusCircle');
            const roomMessageElement = document.getElementById('roomMessage');

            // Set status text
            roomStatusElement.textContent = status.toUpperCase();

            // Set message based on status
            let message = "";

            // Update colors and message based on status
            switch (currentRoomStatus) {
                case 'Quiet Room':
                    roomStatusCircle.style.background = 'linear-gradient(135deg, #2ecc71, #27ae60)';
                    message = "Room is available for use";
                    break;

                case 'Group Work Room':
                    roomStatusCircle.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                    message = "Room is currently occupied";
                    break;

                default:
                    roomStatusCircle.style.background = 'linear-gradient(135deg, #95a5a6, #7f8c8d)';
                    message = "Room status: " + status;
            }

            roomMessageElement.textContent = message;

            console.log("Room status updated to:", status);
        }

        // Update people count display
        function updatePeopleCount(count) {
            const countElement = document.getElementById('peopleCount');
            const countValueElement = document.getElementById('peopleCountValue');

            countElement.textContent = count;

            // Color code based on occupancy
            const peopleCount = parseInt(count);
            if (peopleCount === 0) {
                countValueElement.style.color = '#2ecc71'; 
            } else if (peopleCount < 5) {
                countValueElement.style.color = '#f39c12'; 
            } else {
                countValueElement.style.color = '#e74c3c'; 
            }
        }

        // Update temperature display
        function updateTemperature(value) {
            currentTemperature = parseFloat(value);
            const tempElement = document.getElementById('temperature');

            if (!isNaN(currentTemperature)) {
                tempElement.textContent = currentTemperature.toFixed(1);

                // Change color based on temperature
                const tempValueElement = document.getElementById('temperatureValue');
                if (currentTemperature < 18) {
                    tempValueElement.style.color = '#3498db';
                } else if (currentTemperature > 25) {
                    tempValueElement.style.color = '#e74c3c';
                } else {
                    tempValueElement.style.color = '#2c3e50';
                }
            }
        }

        // Update humidity display
        function updateHumidity(value) {
            currentHumidity = parseFloat(value);
            const humidityElement = document.getElementById('humidity');

            if (!isNaN(currentHumidity)) {
                humidityElement.textContent = currentHumidity.toFixed(0);

                // Change color based on humidity
                const humidityValueElement = document.getElementById('humidityValue');
                if (currentHumidity < 30) {
                    humidityValueElement.style.color = '#f39c12';
                } else if (currentHumidity > 70) {
                    humidityValueElement.style.color = '#3498db';
                } else {
                    humidityValueElement.style.color = '#2c3e50';
                }
            }
        }

        // Update noise display
        function updateNoise(value) {
            currentNoise = parseInt(value);
            const noiseElement = document.getElementById('noiseValue');
            const noiseFill = document.getElementById('noiseFill');

            if (!isNaN(currentNoise)) {
                noiseElement.textContent = currentNoise;

                // Calculate noise percentage
                const noisePercent = Math.min(100, (currentNoise / 4095) * 100);
                noiseFill.style.width = noisePercent + '%';

                // Change color based on noise level
                if (currentNoise < 1000) {
                    noiseFill.style.background = 'linear-gradient(90deg, #2ecc71, #27ae60)';
                } else if (currentNoise < 2500) {
                    noiseFill.style.background = 'linear-gradient(90deg, #f39c12, #e67e22)';
                } else {
                    noiseFill.style.background = 'linear-gradient(90deg, #e74c3c, #c0392b)';
                }
            }
        }

        // Update last update time
        function updateLastUpdateTime() {
            if (lastMessageTime) {
                const now = new Date();
                const diffMs = now - lastMessageTime;
                const diffSec = Math.floor(diffMs / 1000);

                let timeText;
                if (diffSec < 60) {
                    timeText = "Just now";
                } else if (diffSec < 3600) {
                    const minutes = Math.floor(diffSec / 60);
                    timeText = `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
                } else {
                    timeText = lastMessageTime.toLocaleTimeString();
                }

                document.getElementById('lastUpdate').textContent =
                    `Last updated: ${timeText}`;
            }
        }

        // Update connection status display
        function updateConnectionStatus(text, connected) {
            const connectionText = document.getElementById('connectionText');
            const connectionDot = document.getElementById('connectionDot');

            connectionText.textContent = text;
            isConnected = connected;

            if (connected) {
                connectionDot.classList.add('connected');
                connectionDot.classList.remove('disconnected');
            } else {
                connectionDot.classList.remove('connected');
                connectionDot.classList.add('disconnected');
            }
        }

        // Check connection health
        function checkConnection() {
            const now = new Date();

            if (!lastMessageTime) {
                if (isConnected) {
                    updateConnectionStatus("Connected, waiting for data...", true);
                }
                return;
            }

            const diffMs = now - lastMessageTime;
            const diffSec = Math.floor(diffMs / 1000);

            if (diffSec > 120) { // No data for 2 minutes
                updateConnectionStatus("No data received (2+ minutes)", false);
            } else if (diffSec > 60) { // No data for 1 minute
                updateConnectionStatus("Data delayed", true);
            } else if (isConnected) {
                updateConnectionStatus("Connected to Adafruit IO", true);
            }
        }

        // Fallback polling if MQTT doesn't work
        function startFallbackPolling() {
            console.log("Starting fallback polling...");
            setInterval(fetchDataViaAPI, 5000);
        }

        // Fetch data via REST API (fallback)
        async function fetchDataViaAPI() {
            try {
                const feeds = ['room-status', 'temperature', 'humidity', 'noise'];

                for (const feed of feeds) {
                    const response = await fetch(
                        `https://io.adafruit.com/api/v2/${AIO_USERNAME}/feeds/${feed}/data/last`,
                        {
                            headers: {
                                'X-AIO-Key': AIO_KEY
                            }
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        // Simulate MQTT message
                        const topic = `${AIO_USERNAME}/feeds/${feed}`;
                        onMessage(topic, data.value);
                    }
                }
            } catch (error) {
                console.error("Fallback polling error:", error);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);

        // Start fallback polling after 30 seconds if no MQTT connection
        setTimeout(() => {
            if (!isConnected) {
                console.log("MQTT not connected, starting fallback polling...");
                startFallbackPolling();
            }
        }, 30000);
    </script>
</body>

</html>